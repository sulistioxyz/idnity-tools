{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tuf/Documents/APPS/IDnity%20Tools%20v2/idnity-tools/app/api/my-ip/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst rateLimitMap = new Map<string, { count: number; lastRequest: number }>();\r\nconst LIMIT = 3; \r\nconst WINDOW_TIME = 60 * 1000; \r\n\r\nexport async function GET(request: Request) {\r\n  let visitorIp = request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || '127.0.0.1';\r\n  if (visitorIp.includes(',')) {\r\n    visitorIp = visitorIp.split(',')[0].trim();\r\n  }\r\n\r\n  const now = Date.now();\r\n  const userRate = rateLimitMap.get(visitorIp) || { count: 0, lastRequest: now };\r\n\r\n  if (now - userRate.lastRequest > WINDOW_TIME) {\r\n    userRate.count = 0;\r\n    userRate.lastRequest = now;\r\n  }\r\n\r\n  if (userRate.count >= LIMIT) {\r\n    // Hitung sisa detik secara akurat\r\n    const retryAfter = Math.ceil((userRate.lastRequest + WINDOW_TIME - now) / 1000);\r\n    return NextResponse.json(\r\n      { \r\n        error: \"Terlalu banyak permintaan. Silakan coba lagi nanti.\", \r\n        retryAfter: retryAfter // Kirim sisa detik ke frontend\r\n      },\r\n      { status: 429 }\r\n    );\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const queryIp = searchParams.get('ip');\r\n  let ipToLookup = queryIp;\r\n\r\n  if (!ipToLookup) {\r\n    const isLocalhost = visitorIp === '::1' || visitorIp === '127.0.0.1' || !visitorIp;\r\n    ipToLookup = isLocalhost ? '8.8.8.8' : visitorIp;\r\n  }\r\n\r\n  try {\r\n    const geoResponse = await fetch(\r\n      `http://ip-api.com/json/${ipToLookup}?fields=status,message,query,country,regionName,city,lat,lon,timezone,isp,org,as`\r\n    );\r\n    const geoData = await geoResponse.json();\r\n\r\n    if (geoData.status === 'fail') {\r\n      return NextResponse.json({ error: \"IP yang dimasukan tidak Valid\", ip: ipToLookup }, { status: 400 });\r\n    }\r\n\r\n    userRate.count += 1;\r\n    rateLimitMap.set(visitorIp, userRate);\r\n\r\n    return NextResponse.json({\r\n      ip: geoData.query,\r\n      city: geoData.city || '-',\r\n      region: geoData.regionName || '-',\r\n      country: geoData.country || '-',\r\n      isp: geoData.isp || '-',\r\n      asn: geoData.as || '-',\r\n      timezone: geoData.timezone || '-',\r\n      lat: geoData.lat,\r\n      lon: geoData.lon,\r\n      org: geoData.org\r\n    });\r\n  } catch (error) {\r\n    return NextResponse.json({ error: 'Gagal mengambil data lokasi', ip: ipToLookup }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eAAe,IAAI;AACzB,MAAM,QAAQ;AACd,MAAM,cAAc,KAAK;AAElB,eAAe,IAAI,OAAgB;IACxC,IAAI,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;IAC9F,IAAI,UAAU,QAAQ,CAAC,MAAM;QAC3B,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAC1C;IAEA,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,WAAW,aAAa,GAAG,CAAC,cAAc;QAAE,OAAO;QAAG,aAAa;IAAI;IAE7E,IAAI,MAAM,SAAS,WAAW,GAAG,aAAa;QAC5C,SAAS,KAAK,GAAG;QACjB,SAAS,WAAW,GAAG;IACzB;IAEA,IAAI,SAAS,KAAK,IAAI,OAAO;QAC3B,kCAAkC;QAClC,MAAM,aAAa,KAAK,IAAI,CAAC,CAAC,SAAS,WAAW,GAAG,cAAc,GAAG,IAAI;QAC1E,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,YAAY,WAAW,+BAA+B;QACxD,GACA;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,UAAU,aAAa,GAAG,CAAC;IACjC,IAAI,aAAa;IAEjB,IAAI,CAAC,YAAY;QACf,MAAM,cAAc,cAAc,SAAS,cAAc,eAAe,CAAC;QACzE,aAAa,cAAc,YAAY;IACzC;IAEA,IAAI;QACF,MAAM,cAAc,MAAM,MACxB,CAAC,uBAAuB,EAAE,WAAW,gFAAgF,CAAC;QAExH,MAAM,UAAU,MAAM,YAAY,IAAI;QAEtC,IAAI,QAAQ,MAAM,KAAK,QAAQ;YAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAiC,IAAI;YAAW,GAAG;gBAAE,QAAQ;YAAI;QACrG;QAEA,SAAS,KAAK,IAAI;QAClB,aAAa,GAAG,CAAC,WAAW;QAE5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI,QAAQ,KAAK;YACjB,MAAM,QAAQ,IAAI,IAAI;YACtB,QAAQ,QAAQ,UAAU,IAAI;YAC9B,SAAS,QAAQ,OAAO,IAAI;YAC5B,KAAK,QAAQ,GAAG,IAAI;YACpB,KAAK,QAAQ,EAAE,IAAI;YACnB,UAAU,QAAQ,QAAQ,IAAI;YAC9B,KAAK,QAAQ,GAAG;YAChB,KAAK,QAAQ,GAAG;YAChB,KAAK,QAAQ,GAAG;QAClB;IACF,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAA+B,IAAI;QAAW,GAAG;YAAE,QAAQ;QAAI;IACnG;AACF"}}]
}