{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tuf/Documents/APPS/IDnity%20Tools%20v2/idnity-tools/app/api/dns/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport dns from 'node:dns/promises';\r\n\r\nconst rateLimitMap = new Map<string, { count: number; lastRequest: number }>();\r\nconst LIMIT = 3; \r\nconst WINDOW_TIME = 60 * 1000; \r\n\r\n// Konfigurasi Resolver Global untuk pengecekan propagasi\r\nconst resolvers = [\r\n  { name: 'Google DNS (Global)', ip: '8.8.8.8', location: 'USA' },\r\n  { name: 'Cloudflare (Global)', ip: '1.1.1.1', location: 'Europe' },\r\n  { name: 'OpenDNS (Global)', ip: '208.67.222.222', location: 'Singapore' },\r\n  { name: 'Quad9 (Global)', ip: '9.9.9.9', location: 'Australia' }\r\n];\r\n\r\nexport async function GET(request: Request) {\r\n  let visitorIp = request.headers.get('x-forwarded-for') || '127.0.0.1';\r\n  if (visitorIp.includes(',')) visitorIp = visitorIp.split(',')[0].trim();\r\n\r\n  const now = Date.now();\r\n  const userRate = rateLimitMap.get(visitorIp) || { count: 0, lastRequest: now };\r\n\r\n  if (now - userRate.lastRequest > WINDOW_TIME) {\r\n    userRate.count = 0;\r\n    userRate.lastRequest = now;\r\n  }\r\n\r\n  if (userRate.count >= LIMIT) {\r\n    const retryAfter = Math.ceil((userRate.lastRequest + WINDOW_TIME - now) / 1000);\r\n    return NextResponse.json({ error: \"Terlalu banyak permintaan.\", retryAfter }, { status: 429 });\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const domain = searchParams.get('domain')?.replace(/^https?:\\/\\//, '').split('/')[0].toLowerCase();\r\n\r\n  if (!domain || !domain.includes('.')) {\r\n    return NextResponse.json({ error: \"Nama domain tidak valid\" }, { status: 400 });\r\n  }\r\n\r\n  try {\r\n    // 1. Ambil Record Utama menggunakan teknik Dual-Lookup untuk NS\r\n    const [a, mx, txt, ns, nsAlternative] = await Promise.allSettled([\r\n      dns.resolve(domain, 'A'),\r\n      dns.resolve(domain, 'MX'),\r\n      dns.resolve(domain, 'TXT'),\r\n      dns.resolveNs(domain),      // Metode 1: Khusus NS\r\n      dns.resolve(domain, 'NS'),   // Metode 2: Query standar (Cadangan)\r\n    ]);\r\n\r\n    // Gabungkan hasil NS, hilangkan duplikat, dan ubah ke lowercase\r\n    const nsCombined = [];\r\n    if (ns.status === 'fulfilled') nsCombined.push(...ns.value);\r\n    if (nsAlternative.status === 'fulfilled') nsCombined.push(...nsAlternative.value);\r\n    const uniqueNs = Array.from(new Set(nsCombined)).map(n => n.toLowerCase());\r\n\r\n    // 2. Simulasi Global Propagation (A Record)\r\n    const propagation = await Promise.all(resolvers.map(async (r) => {\r\n      const resolver = new dns.Resolver();\r\n      resolver.setServers([r.ip]);\r\n      try {\r\n        const result = await resolver.resolve4(domain);\r\n        return { ...r, result: result[0], status: 'OK' };\r\n      } catch {\r\n        return { ...r, result: 'Not Found', status: 'FAIL' };\r\n      }\r\n    }));\r\n\r\n    userRate.count += 1;\r\n    rateLimitMap.set(visitorIp, userRate);\r\n\r\n    return NextResponse.json({\r\n      domain,\r\n      records: {\r\n        A: a.status === 'fulfilled' ? a.value : [],\r\n        MX: mx.status === 'fulfilled' ? mx.value : [],\r\n        TXT: txt.status === 'fulfilled' ? txt.value.flat() : [],\r\n        NS: uniqueNs, // Hasil gabungan yang lebih akurat\r\n      },\r\n      propagation \r\n    });\r\n  } catch (error) {\r\n    return NextResponse.json({ error: \"Gagal mengambil data DNS\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}