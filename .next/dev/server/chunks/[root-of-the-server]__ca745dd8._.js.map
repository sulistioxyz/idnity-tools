{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tuf/Documents/APPS/IDnity%20Tools%20v2/idnity-tools/app/api/whois/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst rateLimitMap = new Map<string, { count: number; lastRequest: number }>();\r\nconst LIMIT = 3; \r\nconst WINDOW_TIME = 60 * 1000; \r\n\r\nexport async function GET(request: Request) {\r\n  let visitorIp = request.headers.get('x-forwarded-for') || '127.0.0.1';\r\n  if (visitorIp.includes(',')) visitorIp = visitorIp.split(',')[0].trim();\r\n\r\n  const now = Date.now();\r\n  const userRate = rateLimitMap.get(visitorIp) || { count: 0, lastRequest: now };\r\n\r\n  if (now - userRate.lastRequest > WINDOW_TIME) {\r\n    userRate.count = 0;\r\n    userRate.lastRequest = now;\r\n  }\r\n\r\n  if (userRate.count >= LIMIT) {\r\n    const retryAfter = Math.ceil((userRate.lastRequest + WINDOW_TIME - now) / 1000);\r\n    return NextResponse.json({ error: \"Terlalu banyak permintaan.\", retryAfter }, { status: 429 });\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const domain = searchParams.get('domain')?.replace(/^https?:\\/\\//, '').split('/')[0].toLowerCase();\r\n\r\n  if (!domain || !domain.includes('.')) {\r\n    return NextResponse.json({ error: \"Nama domain tidak valid\" }, { status: 400 });\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`https://rdap.org/domain/${domain}`);\r\n    \r\n    if (response.status === 404) {\r\n      return NextResponse.json({ status: 'AVAILABLE', domain });\r\n    }\r\n\r\n    const rdapData = await response.json();\r\n    userRate.count += 1;\r\n    rateLimitMap.set(visitorIp, userRate);\r\n\r\n    // --- PERBAIKAN LOGIKA REGISTRAR ---\r\n    const registrarEntity = rdapData.entities?.find((e: any) => e.roles.includes('registrar'));\r\n    const vcard = registrarEntity?.vcardArray?.[1] || [];\r\n    // Cari properti 'fn' (Full Name) di dalam vcard\r\n    const registrarName = vcard.find((prop: any) => prop[0] === 'fn')?.[3] || \"N/A\";\r\n\r\n    const events = rdapData.events || [];\r\n    const created = events.find((e: any) => e.eventAction === 'registration')?.eventDate;\r\n    const expiry = events.find((e: any) => e.eventAction === 'expiration')?.eventDate;\r\n    const updated = events.find((e: any) => e.eventAction === 'last changed')?.eventDate;\r\n    \r\n    const status = rdapData.status || [];\r\n    const nameservers = rdapData.nameservers?.map((ns: any) => ns.ldhName.toLowerCase()) || [];\r\n\r\n    return NextResponse.json({\r\n      status: 'REGISTERED',\r\n      domain,\r\n      registrar: registrarName, // Sekarang mengambil nama asli, bukan \"4.0\"\r\n      created,\r\n      expiry,\r\n      updated,\r\n      domainStatus: status.join(', '),\r\n      nameservers: nameservers.join(', ')\r\n    });\r\n  } catch (error) {\r\n    return NextResponse.json({ error: \"Gagal mengambil data domain\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eAAe,IAAI;AACzB,MAAM,QAAQ;AACd,MAAM,cAAc,KAAK;AAElB,eAAe,IAAI,OAAgB;IACxC,IAAI,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAC1D,IAAI,UAAU,QAAQ,CAAC,MAAM,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAErE,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,WAAW,aAAa,GAAG,CAAC,cAAc;QAAE,OAAO;QAAG,aAAa;IAAI;IAE7E,IAAI,MAAM,SAAS,WAAW,GAAG,aAAa;QAC5C,SAAS,KAAK,GAAG;QACjB,SAAS,WAAW,GAAG;IACzB;IAEA,IAAI,SAAS,KAAK,IAAI,OAAO;QAC3B,MAAM,aAAa,KAAK,IAAI,CAAC,CAAC,SAAS,WAAW,GAAG,cAAc,GAAG,IAAI;QAC1E,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAA8B;QAAW,GAAG;YAAE,QAAQ;QAAI;IAC9F;IAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,SAAS,aAAa,GAAG,CAAC,WAAW,QAAQ,gBAAgB,IAAI,MAAM,IAAI,CAAC,EAAE,CAAC;IAErF,IAAI,CAAC,UAAU,CAAC,OAAO,QAAQ,CAAC,MAAM;QACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IAC/E;IAEA,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,CAAC,wBAAwB,EAAE,QAAQ;QAEhE,IAAI,SAAS,MAAM,KAAK,KAAK;YAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;gBAAa;YAAO;QACzD;QAEA,MAAM,WAAW,MAAM,SAAS,IAAI;QACpC,SAAS,KAAK,IAAI;QAClB,aAAa,GAAG,CAAC,WAAW;QAE5B,qCAAqC;QACrC,MAAM,kBAAkB,SAAS,QAAQ,EAAE,KAAK,CAAC,IAAW,EAAE,KAAK,CAAC,QAAQ,CAAC;QAC7E,MAAM,QAAQ,iBAAiB,YAAY,CAAC,EAAE,IAAI,EAAE;QACpD,gDAAgD;QAChD,MAAM,gBAAgB,MAAM,IAAI,CAAC,CAAC,OAAc,IAAI,CAAC,EAAE,KAAK,OAAO,CAAC,EAAE,IAAI;QAE1E,MAAM,SAAS,SAAS,MAAM,IAAI,EAAE;QACpC,MAAM,UAAU,OAAO,IAAI,CAAC,CAAC,IAAW,EAAE,WAAW,KAAK,iBAAiB;QAC3E,MAAM,SAAS,OAAO,IAAI,CAAC,CAAC,IAAW,EAAE,WAAW,KAAK,eAAe;QACxE,MAAM,UAAU,OAAO,IAAI,CAAC,CAAC,IAAW,EAAE,WAAW,KAAK,iBAAiB;QAE3E,MAAM,SAAS,SAAS,MAAM,IAAI,EAAE;QACpC,MAAM,cAAc,SAAS,WAAW,EAAE,IAAI,CAAC,KAAY,GAAG,OAAO,CAAC,WAAW,OAAO,EAAE;QAE1F,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,QAAQ;YACR;YACA,WAAW;YACX;YACA;YACA;YACA,cAAc,OAAO,IAAI,CAAC;YAC1B,aAAa,YAAY,IAAI,CAAC;QAChC;IACF,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;IACnF;AACF"}}]
}