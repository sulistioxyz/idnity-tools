{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tuf/Documents/APPS/IDnity%20Tools%20v2/idnity-tools/app/api/ssl-check/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport tls from 'tls';\r\n\r\nconst rateLimitMap = new Map<string, { count: number; lastRequest: number }>();\r\nconst LIMIT = 3; \r\nconst WINDOW_TIME = 60 * 1000; \r\n\r\nexport async function GET(request: Request) {\r\n  let visitorIp = request.headers.get('x-forwarded-for') || '127.0.0.1';\r\n  if (visitorIp.includes(',')) visitorIp = visitorIp.split(',')[0].trim();\r\n\r\n  const now = Date.now();\r\n  const userRate = rateLimitMap.get(visitorIp) || { count: 0, lastRequest: now };\r\n\r\n  if (now - userRate.lastRequest > WINDOW_TIME) {\r\n    userRate.count = 0;\r\n    userRate.lastRequest = now;\r\n  }\r\n\r\n  if (userRate.count >= LIMIT) {\r\n    // HITUNG RETRY AFTER SECARA AKURAT\r\n    const retryAfter = Math.ceil((userRate.lastRequest + WINDOW_TIME - now) / 1000);\r\n    return NextResponse.json({ \r\n      error: \"Terlalu banyak permintaan. Silakan coba lagi nanti.\", \r\n      retryAfter \r\n    }, { status: 429 });\r\n  }\r\n\r\n  const { searchParams } = new URL(request.url);\r\n  const rawDomain = searchParams.get('domain') || '';\r\n  const domain = rawDomain.replace(/^https?:\\/\\//, '').split('/')[0].split(':')[0];\r\n\r\n  if (!domain || domain.length < 3) {\r\n    return NextResponse.json({ error: \"Nama domain tidak valid\" }, { status: 400 });\r\n  }\r\n\r\n  return new Promise((resolve) => {\r\n    const socket = tls.connect(443, domain, { servername: domain, rejectUnauthorized: false }, () => {\r\n      const cert = socket.getPeerCertificate();\r\n      socket.end();\r\n\r\n      if (!cert || Object.keys(cert).length === 0) {\r\n        resolve(NextResponse.json({ error: \"Sertifikat SSL tidak ditemukan\" }, { status: 400 }));\r\n        return;\r\n      }\r\n\r\n      userRate.count += 1;\r\n      rateLimitMap.set(visitorIp, userRate);\r\n\r\n      resolve(NextResponse.json({\r\n        subject: cert.subject?.CN || domain,\r\n        issuer: cert.issuer?.O || cert.issuer?.CN || \"Unknown Issuer\",\r\n        validFrom: cert.valid_from,\r\n        validTo: cert.valid_to,\r\n        remainingDays: Math.ceil((new Date(cert.valid_to).getTime() - Date.now()) / (1000 * 60 * 60 * 24)),\r\n      }));\r\n    });\r\n\r\n    socket.setTimeout(10000);\r\n    socket.on('timeout', () => { socket.destroy(); resolve(NextResponse.json({ error: \"Waktu koneksi habis (Timeout)\" }, { status: 408 })); });\r\n    socket.on('error', () => { socket.destroy(); resolve(NextResponse.json({ error: \"Gagal terhubung ke domain.\" }, { status: 400 })); });\r\n  });\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,eAAe,IAAI;AACzB,MAAM,QAAQ;AACd,MAAM,cAAc,KAAK;AAElB,eAAe,IAAI,OAAgB;IACxC,IAAI,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAC1D,IAAI,UAAU,QAAQ,CAAC,MAAM,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAErE,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,WAAW,aAAa,GAAG,CAAC,cAAc;QAAE,OAAO;QAAG,aAAa;IAAI;IAE7E,IAAI,MAAM,SAAS,WAAW,GAAG,aAAa;QAC5C,SAAS,KAAK,GAAG;QACjB,SAAS,WAAW,GAAG;IACzB;IAEA,IAAI,SAAS,KAAK,IAAI,OAAO;QAC3B,mCAAmC;QACnC,MAAM,aAAa,KAAK,IAAI,CAAC,CAAC,SAAS,WAAW,GAAG,cAAc,GAAG,IAAI;QAC1E,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP;QACF,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,YAAY,aAAa,GAAG,CAAC,aAAa;IAChD,MAAM,SAAS,UAAU,OAAO,CAAC,gBAAgB,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;IAEhF,IAAI,CAAC,UAAU,OAAO,MAAM,GAAG,GAAG;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IAC/E;IAEA,OAAO,IAAI,QAAQ,CAAC;QAClB,MAAM,SAAS,0GAAG,CAAC,OAAO,CAAC,KAAK,QAAQ;YAAE,YAAY;YAAQ,oBAAoB;QAAM,GAAG;YACzF,MAAM,OAAO,OAAO,kBAAkB;YACtC,OAAO,GAAG;YAEV,IAAI,CAAC,QAAQ,OAAO,IAAI,CAAC,MAAM,MAAM,KAAK,GAAG;gBAC3C,QAAQ,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAiC,GAAG;oBAAE,QAAQ;gBAAI;gBACrF;YACF;YAEA,SAAS,KAAK,IAAI;YAClB,aAAa,GAAG,CAAC,WAAW;YAE5B,QAAQ,gJAAY,CAAC,IAAI,CAAC;gBACxB,SAAS,KAAK,OAAO,EAAE,MAAM;gBAC7B,QAAQ,KAAK,MAAM,EAAE,KAAK,KAAK,MAAM,EAAE,MAAM;gBAC7C,WAAW,KAAK,UAAU;gBAC1B,SAAS,KAAK,QAAQ;gBACtB,eAAe,KAAK,IAAI,CAAC,CAAC,IAAI,KAAK,KAAK,QAAQ,EAAE,OAAO,KAAK,KAAK,GAAG,EAAE,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE;YAClG;QACF;QAEA,OAAO,UAAU,CAAC;QAClB,OAAO,EAAE,CAAC,WAAW;YAAQ,OAAO,OAAO;YAAI,QAAQ,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC,GAAG;gBAAE,QAAQ;YAAI;QAAK;QACxI,OAAO,EAAE,CAAC,SAAS;YAAQ,OAAO,OAAO;YAAI,QAAQ,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAAK;IACrI;AACF"}}]
}